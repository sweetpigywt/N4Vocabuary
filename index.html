<!DOCTYPE html>
<html lang="ja" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>JLPT N4 æ—¥æœ¬èªèƒ½åŠ›è©¦é¨“</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --accent: #4834d4;
            --success: #27ae60;
            --error: #eb4d4b;
            --text-main: #2d3436;
            --shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: var(--primary-bg);
            background-attachment: fixed;
            margin: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
            /* ç¦æ­¢æ–‡å­—é€‰æ‹© */
            -webkit-user-select: none; user-select: none;
            overflow-x: hidden;
        }

        .container {
            width: 90%; max-width: 500px;
            background: var(--glass-bg);
            padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            text-align: center; position: relative;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .hidden { display: none !important; }

        /* UI Elements */
        h1, h2, h3 { color: var(--accent); margin-top: 0; }
        .input-group { text-align: left; margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #555; }
        
        input, select {
            width: 100%; padding: 12px; border: 2px solid #eee;
            border-radius: 10px; font-size: 16px; transition: 0.3s;
            -webkit-user-select: text; user-select: text; /* å…è®¸è¾“å…¥æ¡†è¾“å…¥ */
        }
        input:focus { border-color: var(--accent); outline: none; }

        button {
            width: 100%; padding: 15px; background: var(--accent); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: all 0.2s;
        }
        button:hover { transform: translateY(-2px); opacity: 0.9; box-shadow: 0 5px 15px rgba(72, 52, 212, 0.3); }
        button:active { transform: scale(0.98); }

        /* Quiz UI */
        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.4s ease; }
        .info-header { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: bold; }
        .question-text { font-size: 18px; font-weight: bold; margin: 25px 0; text-align: left; line-height: 1.6; }
        .option-btn {
            background: #fff; color: var(--text-main); border: 2px solid #eee;
            text-align: left; margin-bottom: 12px; font-weight: normal;
        }
        .option-btn:hover { border-color: var(--accent); background: #f8f9ff; }

        /* Result UI */
        .score-big { font-size: 64px; font-weight: bold; color: var(--accent); margin: 10px 0; }
        .result-meta { font-size: 14px; color: #666; margin-bottom: 20px; }
        .analysis-scroll { max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; text-align: left; padding: 10px; }
        .analysis-card { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .analysis-card:last-child { border-bottom: none; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .tag-correct { background: #e3f9eb; color: var(--success); }
        .tag-wrong { background: #fee2e2; color: var(--error); }

        /* History Tabs */
        .tab-box { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 12px; background: #eee; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .history-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .history-item { padding: 12px; background: white; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid var(--accent); font-size: 14px; }

        /* Cheat Overlay */
        #cheat-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.98); color: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px;
        }
        .cheat-title { font-size: 80px; color: var(--error); margin: 0; }

        /* Loader */
        .spinner {
            border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-wrap { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); z-index: 1000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="setup" class="container">
        <h1>N4 æ–‡æ³•ãƒ†ã‚¹ãƒˆ</h1>
        <div class="input-group">
            <label>æ°å (Full Name)</label>
            <input type="text" id="user-name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
        </div>
        <div class="input-group">
            <label>å­¦ç±ç•ªå· (Student ID)</label>
            <input type="text" id="user-id" placeholder="ä¾‹ï¼šS580">
        </div>
        <div class="input-group">
            <label>ã‚¯ãƒ©ã‚¹ (Class)</label>
            <select id="user-cls">
                <option value="SP12">SP12</option>
                <option value="SP13">SP13</option>
            </select>
        </div>
        <button onclick="initExam()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button onclick="showHistory()" style="background:#555;">é–“é•ãˆãŸå•é¡Œã‚’ç¢ºèª</button>
        <button onclick="window.open('https://docs.google.com/spreadsheets/d/1h6CudBvYWLorOfHtO42nja--t2A1pWO1H8XnRts1PpA/edit?gid=0#gid=0')" style="background:#777; font-size:12px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
    </div>

    <div id="quiz" class="container hidden">
        <div class="info-header">
            <span id="quiz-user-info">ã‚¯ãƒ©ã‚¹ | æ°å</span>
            <span id="q-number">Q1 / 20</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
        <div class="question-text" id="q-text">å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div id="options-area"></div>
    </div>

    <div id="result" class="container hidden">
        <h2>çµæœç™ºè¡¨</h2>
        <div id="result-meta" class="result-meta"></div>
        <div class="score-big" id="final-score">0 / 20</div>
        <div class="analysis-scroll" id="analysis-list"></div>
        <button onclick="location.reload()" style="margin-top:20px;">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
    </div>

    <div id="history" class="container hidden">
        <h3>å¼±ç‚¹åˆ†æ</h3>
        <div class="tab-box">
            <div class="tab-btn active" id="tab-3" onclick="renderHistory(3)">ğŸ”¥ 3å›ä»¥ä¸Š</div>
            <div class="tab-btn" id="tab-2" onclick="renderHistory(2)">âš ï¸ 2å›</div>
            <div class="tab-btn" id="tab-1" onclick="renderHistory(1)">ğŸ“– 1å›</div>
        </div>
        <div id="history-content" class="history-list"></div>
        <button onclick="location.reload()" style="margin-top:15px; background:#555;">æˆ»ã‚‹</button>
    </div>

    <div id="cheat-overlay" class="hidden">
        <h1 class="cheat-title">å¤±æ ¼</h1>
        <p style="font-size: 20px; text-align: center;">ãƒ†ã‚¹ãƒˆä¸­ã«ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚<br>ã“ã®ãƒ†ã‚¹ãƒˆã¯ç„¡åŠ¹ã§ã™ã€‚</p>
        <button onclick="location.reload()" style="width: 200px; background: white; color: black;">æˆ»ã‚‹</button>
    </div>

    <div id="loader" class="loader-wrap hidden">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:bold; color:var(--accent);">ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...</p>
    </div>

    <script>
        // ================= CONFIG & DATA =================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwREfW1TphcbB9ZJLeEiM3SsS_GT5KrObR4dhcDRnfySmbxKGe23FWvBMTcX52HXJ_Czw/exec";
        const QUESTIONS_TO_DRAW = 20;

        // é¢˜åº“é›†ä¸­ç®¡ç† (ç»“æ„åŒ–JSON)
        const allQuestions = [
            { question: "æ˜¨æ—¥ã€ãƒ‡ãƒ‘ãƒ¼ãƒˆã¸ï¼ˆã€€ï¼‰ã«è¡Œãã¾ã—ãŸã€‚", options: ["è²·ã„ç‰©", "è²·ã†ã‚‚ã®", "è²·ã„", "è²·ã„ã¦"], answer: 0 },
            { question: "ã“ã®éƒ¨å±‹ã¯ï¼ˆã€€ï¼‰ãªã„ã§ãã ã•ã„ã€‚", options: ["å…¥ã‚‹", "å…¥ã‚‰", "å…¥ã£ã¦", "å…¥ã‚Š"], answer: 1 },
            { question: "ç”°ä¸­ã•ã‚“ã¯ä»Šã€é›»è©±ã‚’ï¼ˆã€€ï¼‰ã„ã¾ã™ã€‚", options: ["ã‹ã‘", "ã‹ã‘ã¦", "ã‹ã‘ã‚‹", "ã‹ã‘ãŸ"], answer: 1 },
            { question: "ç§ã¯æ—¥æœ¬æ–™ç†ã‚’ï¼ˆã€€ï¼‰ã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", options: ["é£Ÿã¹ãŸ", "é£Ÿã¹ã‚‹", "é£Ÿã¹ã¦", "é£Ÿã¹"], answer: 0 },
            { question: "æ˜æ—¥ã€é›¨ãŒï¼ˆã€€ï¼‰ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚", options: ["ãµã‚‹", "ãµã£ã¦", "ãµã‚Š", "ãµã£ãŸ"], answer: 0 },
            { question: "ã“ã®æœ¬ã¯ï¼ˆã€€ï¼‰ã™ãã¦ã€èª­ã‚ã¾ã›ã‚“ã€‚", options: ["ã‚€ãšã‹ã—ã„", "ã‚€ãšã‹ã—ã", "ã‚€ãšã‹ã—", "ã‚€ãšã‹ã—ãã¦"], answer: 2 },
            { question: "çª“ãŒï¼ˆã€€ï¼‰ã„ã¾ã™ã€‚", options: ["ã‚ã‘ã¦", "ã‚ã„ã¦", "ã‚ã‘", "ã‚ã"], answer: 1 },
            { question: "å¼Ÿã¯ãƒ†ãƒ¬ãƒ“ã‚’ï¼ˆã€€ï¼‰ãªãŒã‚‰å‹‰å¼·ã—ã¾ã™ã€‚", options: ["è¦‹ã‚‹", "è¦‹ã¦", "è¦‹", "è¦‹ã¾ã™"], answer: 2 },
            { question: "æ—¥æœ¬èªã‚’ï¼ˆã€€ï¼‰ã®ã¯æ¥½ã—ã„ã§ã™ã€‚", options: ["å‹‰å¼·ã™ã‚‹", "å‹‰å¼·ã—ã¦", "å‹‰å¼·ã—ãŸ", "å‹‰å¼·"], answer: 0 },
            { question: "ã‚ãã“ã«ï¼ˆã€€ï¼‰ã®ã¯ã ã‚Œã§ã™ã‹ã€‚", options: ["ç«‹ã£ã¦", "ç«‹ã£ã¦ã„ã‚‹", "ç«‹ã¤", "ç«‹ã¡"], answer: 1 },
            { question: "æ˜¨æ—¥ã¯ï¼ˆã€€ï¼‰ã§ã—ãŸã€‚", options: ["ä¼‘ã¿", "ä¼‘ã‚€", "ä¼‘ã‚“ã§", "ä¼‘ã¿ã "], answer: 0 },
            { question: "æ—¥æœ¬èªã¯ï¼ˆã€€ï¼‰ã‚€ãšã‹ã—ããªã„ã§ã™ã€‚", options: ["ã‚ã¾ã‚Š", "ãœã‚“ãœã‚“", "ã¨ã¦ã‚‚", "ã™ã“ã—"], answer: 0 },
            { question: "æ¯ã¯ç§ã«éƒ¨å±‹ã‚’ï¼ˆã€€ï¼‰ã•ã›ã¾ã—ãŸã€‚", options: ["æƒé™¤", "æƒé™¤ã™ã‚‹", "æƒé™¤ã—", "æƒé™¤ã—ãŸ"], answer: 0 },
            { question: "é§…ã¾ã§æ­©ã„ã¦ï¼‘ï¼åˆ†ï¼ˆã€€ï¼‰ã‹ã‹ã‚Šã¾ã™ã€‚", options: ["ã ã‘", "ã”ã‚", "ãã‚‰ã„", "ã—ã‹"], answer: 2 },
            { question: "ã‚‚ã£ã¨ï¼ˆã€€ï¼‰è©±ã—ã¦ãã ã•ã„ã€‚", options: ["ã‚†ã£ãã‚Š", "ã‚†ã£ãã‚Šã¨", "ã‚†ã£ãã‚Šãª", "ã‚†ã£ãã‚Šã«"], answer: 0 },
            { question: "ã“ã“ï¼ˆã€€ï¼‰åå‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚", options: ["ã«", "ã‚’", "ã§", "ãŒ"], answer: 0 },
            { question: "ã‚¿ã‚¯ã‚·ãƒ¼ï¼ˆã€€ï¼‰å¸°ã‚Šã¾ã—ã‚‡ã†ã€‚", options: ["ã§", "ã«", "ã‚’", "ã‹ã‚‰"], answer: 0 },
            { question: "æã•ã‚“ã¯è‹±èªï¼ˆã€€ï¼‰ä¸Šæ‰‹ã§ã™ã€‚", options: ["ã‚’", "ãŒ", "ã«", "ã¸"], answer: 1 },
            { question: "å­¦æ ¡ï¼ˆã€€ï¼‰ä¼‘ã‚“ã§ã€ç—…é™¢ã¸è¡Œãã¾ã—ãŸã€‚", options: ["ã‚’", "ã«", "ãŒ", "ã§"], answer: 0 },
            { question: "ç§ã¯æ¯æ—¥ã€ï¼‘æ™‚é–“ï¼ˆã€€ï¼‰èµ°ã‚Šã¾ã™ã€‚", options: ["ã”ã‚", "ãã‚‰ã„", "ã—ã‹", "ã¾ã§"], answer: 1 },
            { question: "ï¼ˆã€€ï¼‰é£Ÿã¹ã¾ã—ã‚‡ã†ã€‚", options: ["ã„ã£ã—ã‚‡ã«", "ã„ã£ã—ã‚‡", "ã„ã£ã—ã‚‡ã ", "ã„ã£ã—ã‚‡ã§"], answer: 0 },
            { question: "ã‚ãã“ã«åº§ã£ã¦ï¼ˆã€€ï¼‰äººã¯ã ã‚Œã§ã™ã‹ã€‚", options: ["ã„ã‚‹", "ã‚ã‚‹", "ã„ãŸ", "ã‚ã£ãŸ"], answer: 0 }
        ];

        // ================= STATE =================
        let examPool = [];
        let currentIdx = 0;
        let score = 0;
        let quizActive = false;
        let examResults = [];
        let userInfo = {};

        // ================= LOGIC =================

        function initExam() {
            userInfo.name = document.getElementById('user-name').value.trim();
            userInfo.id = document.getElementById('user-id').value.trim();
            userInfo.cls = document.getElementById('user-cls').value;

            if (!userInfo.name || !userInfo.id) return alert("æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

            // 1. éšæœºæŠ½é¢˜å¹¶æ´—ç‰Œ
            examPool = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, QUESTIONS_TO_DRAW);
            
            // 2. åˆå§‹åŒ–çŠ¶æ€
            currentIdx = 0;
            score = 0;
            examResults = [];
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            document.getElementById('quiz-user-info').innerText = `${userInfo.cls} | ${userInfo.name}`;
            
            quizActive = true;
            showQuestion();
        }

        function showQuestion() {
            const q = examPool[currentIdx];
            document.getElementById('q-number').innerText = `Q${currentIdx + 1} / ${examPool.length}`;
            document.getElementById('p-bar').style.width = `${((currentIdx) / examPool.length) * 100}%`;
            document.getElementById('q-text').innerText = q.question;

            const area = document.getElementById('options-area');
            area.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                area.appendChild(btn);
            });
        }

        function selectOption(idx) {
            const q = examPool[currentIdx];
            const isCorrect = (idx === q.answer);
            if (isCorrect) score++;

            examResults.push({
                question: q.question,
                options: q.options,
                correctIdx: q.answer,
                userSelect: idx,
                isCorrect: isCorrect
            });

            // å­˜å…¥é”™é¢˜é›† (localStorage)
            if (!isCorrect) {
                let wrongList = JSON.parse(localStorage.getItem('N4_WRONG_LIST') || '{}');
                if (!wrongList[q.question]) {
                    wrongList[q.question] = { text: q.question, ans: q.options[q.answer], count: 1 };
                } else {
                    wrongList[q.question].count += 1;
                }
                localStorage.setItem('N4_WRONG_LIST', JSON.stringify(wrongList));
            }

            currentIdx++;
            if (currentIdx < examPool.length) {
                showQuestion();
            } else {
                finishExam();
            }
        }

        async function finishExam() {
            quizActive = false;
            document.getElementById('loader').classList.remove('hidden');

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP');

            // æ¸²æŸ“ç»“æœé¡µ
            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('result-meta').innerText = `${userInfo.cls} | ${userInfo.id} | ${userInfo.name}`;
            document.getElementById('final-score').innerText = `${score} / ${examPool.length}`;

            const list = document.getElementById('analysis-list');
            list.innerHTML = examResults.map((r, i) => `
                <div class="analysis-card">
                    <span class="tag ${r.isCorrect ? 'tag-correct' : 'tag-wrong'}">${r.isCorrect ? 'â—‹ æ­£è§£' : 'Ã— ä¸æ­£è§£'}</span><br>
                    <b>Q${i+1}. ${r.question}</b><br>
                    <small>ã‚ãªãŸã®å›ç­”: ${r.options[r.userSelect]}</small><br>
                    <small style="color:var(--success)">æ­£ã—ã„å›ç­”: ${r.options[r.correctIdx]}</small>
                </div>
            `).join('');

            // å‘é€æ•°æ®
            const payload = {
                timestamp: now.toISOString(),
                name: userInfo.name,
                id: userInfo.id,
                cls: userInfo.cls,
                score: score,
                date: dateStr,
                time: timeStr
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    body: JSON.stringify(payload)
                });
            } catch (e) { console.error("Submit error:", e); }

            document.getElementById('loader').classList.add('hidden');
        }

        // ================= HISTORY =================
        function showHistory() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('history').classList.remove('hidden');
            renderHistory(3);
        }

        function renderHistory(level) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${level}`).classList.add('active');

            const wrongData = JSON.parse(localStorage.getItem('N4_WRONG_LIST') || '{}');
            const list = document.getElementById('history-content');
            list.innerHTML = '';

            const filtered = Object.values(wrongData).filter(item => {
                if (level === 3) return item.count >= 3;
                if (level === 2) return item.count === 2;
                return item.count === 1;
            });

            if (filtered.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#999; padding-top:20px;'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<b>${item.text}</b><br><small>æ­£è§£: ${item.ans}</small><br><small style="color:var(--error)">ãƒŸã‚¹å›æ•°: ${item.count}å›</small>`;
                list.appendChild(div);
            });
        }

        // ================= ANTI-CHEAT =================
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden' && quizActive) {
                quizActive = false;
                document.getElementById('quiz').classList.add('hidden');
                document.getElementById('cheat-overlay').classList.remove('hidden');
            }
        });

    </script>
</body>
</html>