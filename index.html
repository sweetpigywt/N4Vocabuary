<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT N4 èªå½™ãƒ†ã‚¹ãƒˆ & èª¤ç­”ãƒªã‚¹ãƒˆ</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif; 
            background-color: #f0f2f5; margin: 0; padding: 20px; color: #333;
            user-select: none; -webkit-user-select: none;
        }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a2a6c; border-bottom: 2px solid #1a2a6c; padding-bottom: 10px; }
        .info-section, .quiz-section, .result-section { display: none; }
        .active { display: block; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        input[type="text"] { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background-color: #1a2a6c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 10px; }
        
        /* ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ */
        .question-text { font-size: 20px; font-weight: bold; color: #000; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 5px solid #1a2a6c; }
        .option-btn { 
            display: block; width: 100%; padding: 16px; margin: 12px 0; text-align: left; 
            background: #ffffff; border: 2px solid #333; color: #000; border-radius: 8px; 
            cursor: pointer; font-size: 18px; font-weight: 600; transition: 0.2s;
        }
        .option-btn:hover { background: #333; color: #fff; }
        
        /* èª¤ç­”ãƒªã‚¹ãƒˆï¼ˆé”™é¢˜æœ¬ï¼‰æ ·å¼ */
        .wrong-record-section { margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .wrong-tier { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .tier-1 { background-color: #fff3cd; border: 1px solid #ffeeba; } /* 1æ¬¡é”™è¯¯ï¼šæ·¡é»„ */
        .tier-2 { background-color: #f8d7da; border: 1px solid #f5c6cb; } /* 2æ¬¡é”™è¯¯ï¼šæ·¡çº¢ */
        .tier-3 { background-color: #721c24; color: white; border: 1px solid #491217; } /* 3æ¬¡ï¼šæ·±çº¢ */
        .wrong-item { margin-bottom: 10px; font-size: 14px; padding: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        
        #cheatOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: white; z-index: 9999;
            text-align: center; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body oncontextmenu="return false">

<div id="cheatOverlay">
    <h1 style="color: #ff4d4d;">ã€å¤±æ ¼ã€‘ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œçŸ¥</h1>
    <p>ãƒ†ã‚¹ãƒˆä¸­ã«ä»–ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ãŸãŸã‚ã€ã“ã®å›ç­”ã¯ç„¡åŠ¹ã§ã™ã€‚</p>
    <button onclick="location.reload()" style="width:200px; background:#fff; color:#000;">æˆ»ã‚‹</button>
</div>

<div class="container">
    <h1>N4èªå½™ãƒ†ã‚¹ãƒˆ & èª¤ç­”ç®¡ç†</h1>

    <div id="setup" class="info-section active">
        <p>æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
        <input type="text" id="userName" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
        <button onclick="startQuiz()">ãƒ†ã‚¹ãƒˆé–‹å§‹ (20å•)</button>
        <button onclick="showHistoryOnly()" style="background-color: #6c757d;">éå»ã®èª¤ç­”ã‚’ç¢ºèªã™ã‚‹</button>
    </div>

    <div id="quiz" class="quiz-section">
        <div id="qText" class="question-text"></div>
        <div id="optionsArea"></div>
    </div>

    <div id="result" class="result-section">
        <div style="text-align: center;">
            <h2>ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div id="scoreDisplay" style="font-size: 48px; color: #d9534f; font-weight: bold;"></div>
            <p id="resInfo"></p>
            <button onclick="location.reload()">å†æŒ‘æˆ¦</button>
            <button onclick="clearHistory()" style="background-color: #dc3545; font-size: 12px; margin-top: 20px;">å…¨å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹</button>
        </div>

        <div class="wrong-record-section">
            <h3 style="text-align: center;">ğŸ“Š èª¤ç­”åˆ†æ (ã“ã‚Œã¾ã§ã®è¨˜éŒ²)</h3>
            
            <div id="tier3" class="wrong-tier tier-3">
                <strong>ã€è¦æ³¨æ„ã€‘3å›ä»¥ä¸Šé–“é•ãˆãŸå•é¡Œï¼š</strong>
                <div id="list3">ãªã—</div>
            </div>
            
            <div id="tier2" class="wrong-tier tier-2">
                <strong>ã€å¾©ç¿’ã€‘2å›é–“é•ãˆãŸå•é¡Œï¼š</strong>
                <div id="list2">ãªã—</div>
            </div>
            
            <div id="tier1" class="wrong-tier tier-1">
                <strong>ã€ç¢ºèªã€‘1å›é–“é•ãˆãŸå•é¡Œï¼š</strong>
                <div id="list1">ãªã—</div>
            </div>
        </div>
    </div>
</div>

<script src="questions.js"></script>
<script>
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let isTesting = false;

    // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼ˆé˜²ä½œå¼Šï¼‰
    document.addEventListener('visibilitychange', function() {
        if (isTesting && document.visibilityState === 'hidden') {
            isTesting = false;
            document.getElementById('cheatOverlay').style.display = 'flex';
        }
    });

    // å¼€å§‹è€ƒè¯•
    function startQuiz() {
        const name = document.getElementById('userName').value;
        if (!name) { alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        isTesting = true;
        currentQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 20);
        document.getElementById('setup').classList.remove('active');
        document.getElementById('quiz').classList.add('active');
        showQuestion();
    }

    // ä»…æŸ¥çœ‹è®°å½•
    function showHistoryOnly() {
        document.getElementById('setup').classList.remove('active');
        document.getElementById('result').classList.add('active');
        renderWrongList();
    }

    function showQuestion() {
        const q = currentQuestions[currentIndex];
        document.getElementById('qText').innerText = `${currentIndex + 1}. ${q.question}`;
        const optionsArea = document.getElementById('optionsArea');
        optionsArea.innerHTML = '';
        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = (i + 1) + ". " + opt;
            btn.onclick = () => handleAnswer(i);
            optionsArea.appendChild(btn);
        });
    }

    function handleAnswer(choice) {
        const q = currentQuestions[currentIndex];
        if (choice === q.answer) {
            score++;
        } else {
            saveWrongAnswer(q); // è®°å½•é”™é¢˜
        }
        currentIndex++;
        if (currentIndex < 20) showQuestion(); else finishQuiz();
    }

    // ä¿å­˜é”™é¢˜é€»è¾‘
    function saveWrongAnswer(questionObj) {
        let history = JSON.parse(localStorage.getItem('jlpt_wrong_history') || '{}');
        const qKey = questionObj.question; // ä»¥é¢˜ç›®å†…å®¹ä½œä¸ºKey
        
        if (!history[qKey]) {
            history[qKey] = { count: 1, text: questionObj.question, ans: questionObj.options[questionObj.answer] };
        } else {
            history[qKey].count += 1;
        }
        localStorage.setItem('jlpt_wrong_history', JSON.stringify(history));
    }

    function finishQuiz() {
        isTesting = false;
        document.getElementById('quiz').classList.remove('active');
        document.getElementById('result').classList.add('active');
        document.getElementById('scoreDisplay').innerText = `${score} / 20`;
        const now = new Date();
        document.getElementById('resInfo').innerText = `å—é¨“è€…: ${document.getElementById('userName').value} | æ—¥æ™‚: ${now.toLocaleString()}`;
        renderWrongList();
    }

    // æ¸²æŸ“é”™é¢˜æœ¬
    function renderWrongList() {
        const history = JSON.parse(localStorage.getItem('jlpt_wrong_history') || '{}');
        const lists = { 1: document.getElementById('list1'), 2: document.getElementById('list2'), 3: document.getElementById('list3') };
        Object.values(lists).forEach(l => l.innerHTML = '');

        let hasData = [false, false, false, false];

        for (const key in history) {
            const item = history[key];
            const div = document.createElement('div');
            div.className = 'wrong-item';
            div.innerHTML = `<strong>å•:</strong> ${item.text}<br><span style="color:blue"><strong>æ­£è§£:</strong> ${item.ans}</span> (ãƒŸã‚¹: ${item.count}å›)`;
            
            if (item.count === 1) { lists[1].appendChild(div); hasData[1] = true; }
            else if (item.count === 2) { lists[2].appendChild(div); hasData[2] = true; }
            else if (item.count >= 3) { lists[3].appendChild(div); hasData[3] = true; }
        }

        if(!hasData[1]) lists[1].innerText = 'ãªã—';
        if(!hasData[2]) lists[2].innerText = 'ãªã—';
        if(!hasData[3]) lists[3].innerText = 'ãªã—';
    }

    function clearHistory() {
        if(confirm("å…¨ã¦ã®å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('jlpt_wrong_history');
            renderWrongList();
        }
    }
</script>
</body>
</html>
