<!DOCTYPE html>
<html lang="ja" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT N4 èªå½™ãƒ†ã‚¹ãƒˆ & èª¤ç­”åˆ†æ</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif; 
            background-color: #f0f2f5; margin: 0; padding: 20px; color: #333;
            user-select: none; -webkit-user-select: none;
        }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a2a6c; border-bottom: 2px solid #1a2a6c; padding-bottom: 10px; }
        .info-section, .quiz-section, .result-section, .history-section { display: none; }
        .active { display: block; }
        
        button { width: 100%; padding: 14px; background-color: #1a2a6c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        input[type="text"] { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        /* ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ */
        .question-text { font-size: 20px; font-weight: bold; color: #000; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 5px solid #1a2a6c; }
        .option-btn { display: block; width: 100%; padding: 16px; margin: 12px 0; text-align: left; background: #ffffff; border: 2px solid #333; color: #000; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600; }
        .option-btn:hover { background: #333; color: #fff; }

        /* ä»Šå›ã®æ­£èª¤ãƒªã‚¹ãƒˆ */
        .review-item { padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 10px solid; }
        .correct-bg { background-color: #e7f4e4; border-color: #28a745; }
        .wrong-bg { background-color: #fceaea; border-color: #dc3545; }
        .status-badge { font-weight: bold; padding: 2px 8px; border-radius: 4px; color: white; margin-right: 10px; }
        .bg-ok { background-color: #28a745; }
        .bg-ng { background-color: #dc3545; }

        /* ç´¯è¨ˆèª¤ç­”ãƒªã‚¹ãƒˆï¼ˆå±¥æ­´ï¼‰ */
        .wrong-tier { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .tier-1 { background-color: #fff3cd; border: 1px solid #ffeeba; }
        .tier-2 { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .tier-3 { background-color: #721c24; color: white; border: 1px solid #491217; }
        .wrong-item { margin-bottom: 10px; font-size: 14px; padding: 5px; border-bottom: 1px solid rgba(0,0,0,0.1); }

        #cheatOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: white; z-index: 9999; text-align: center; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body oncontextmenu="return false">

<div id="cheatOverlay">
    <h1 style="color: #ff4d4d;">ã€å¤±æ ¼ã€‘ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œçŸ¥</h1>
    <p>ãƒ†ã‚¹ãƒˆã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚</p>
    <button onclick="location.reload()" style="width:200px; background:#fff; color:#000;">æˆ»ã‚‹</button>
</div>

<div class="container">
    <h1>N4èªå½™ãƒ†ã‚¹ãƒˆ</h1>

    <div id="setup" class="info-section active">
        <p>æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
        <input type="text" id="userName" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
        <button onclick="startQuiz()">ãƒ†ã‚¹ãƒˆé–‹å§‹ (20å•)</button>
        <button onclick="showHistoryMode()" style="background-color: #6c757d;">ç´¯è¨ˆã®èª¤ç­”ãƒªã‚¹ãƒˆã‚’ç¢ºèªã™ã‚‹</button>
    </div>

    <div id="quiz" class="quiz-section">
        <div id="qText" class="question-text"></div>
        <div id="optionsArea"></div>
    </div>

    <div id="result" class="result-section">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>ä»Šå›ã®ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div id="scoreDisplay" style="font-size: 48px; color: #d9534f; font-weight: bold;"></div>
            <p id="resInfo"></p>
            <button onclick="location.reload()" style="width: 48%;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
            <button onclick="showHistoryMode()" style="width: 48%; background-color: #6c757d;">ç´¯è¨ˆå±¥æ­´ã‚’è¦‹ã‚‹</button>
        </div>
        <hr>
        <h3>ğŸ” ä»Šå›ã®æ­£èª¤è©³ç´°</h3>
        <div id="currentReviewArea"></div>
    </div>

    <div id="history" class="history-section">
        <h2 style="text-align: center;">ğŸ“Š ç´¯è¨ˆèª¤ç­”ãƒªã‚¹ãƒˆ</h2>
        <p style="text-align: center; font-size: 12px; color: #666;">ã“ã‚Œã¾ã§ã®ãƒ†ã‚¹ãƒˆã§é–“é•ãˆãŸå•é¡Œã®çµ±è¨ˆã§ã™ã€‚</p>
        
        <div id="tier3" class="wrong-tier tier-3"><strong>ã€è¦æ³¨æ„ã€‘3å›ä»¥ä¸ŠãƒŸã‚¹ï¼š</strong><div id="list3"></div></div>
        <div id="tier2" class="wrong-tier tier-2"><strong>ã€å¾©ç¿’ã€‘2å›ãƒŸã‚¹ï¼š</strong><div id="list2"></div></div>
        <div id="tier1" class="wrong-tier tier-1"><strong>ã€ç¢ºèªã€‘1å›ãƒŸã‚¹ï¼š</strong><div id="list1"></div></div>
        
        <button onclick="location.reload()">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        <button onclick="clearHistory()" style="background-color: #dc3545; font-size: 12px; margin-top: 20px;">å…¨å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<script src="questions.js"></script>
<script>
    let currentQuestions = [];
    let userChoices = []; // ä»Šå›ã®å›ç­”ã‚’ä¿å­˜
    let currentIndex = 0;
    let score = 0;
    let isTesting = false;

    // é˜²ä½œå¼Š
    document.addEventListener('visibilitychange', function() {
        if (isTesting && document.visibilityState === 'hidden') {
            isTesting = false;
            document.getElementById('cheatOverlay').style.display = 'flex';
        }
    });

    function startQuiz() {
        const name = document.getElementById('userName').value;
        if (!name) { alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        isTesting = true;
        currentQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 20);
        userChoices = [];
        document.getElementById('setup').classList.remove('active');
        document.getElementById('quiz').classList.add('active');
        showQuestion();
    }

    function showQuestion() {
        const q = currentQuestions[currentIndex];
        document.getElementById('qText').innerText = `${currentIndex + 1}. ${q.question}`;
        const optionsArea = document.getElementById('optionsArea');
        optionsArea.innerHTML = '';
        q.options.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = (i + 1) + ". " + opt;
            btn.onclick = () => handleAnswer(i);
            optionsArea.appendChild(btn);
        });
    }

    function handleAnswer(choice) {
        userChoices.push(choice);
        const q = currentQuestions[currentIndex];
        if (choice === q.answer) {
            score++;
        } else {
            saveToCumulativeHistory(q); 
        }
        currentIndex++;
        if (currentIndex < 20) showQuestion(); else finishQuiz();
    }

    // ç´¯è¨ˆå±¥æ­´ã¸ã®ä¿å­˜
    function saveToCumulativeHistory(questionObj) {
        let history = JSON.parse(localStorage.getItem('jlpt_wrong_history') || '{}');
        const qKey = questionObj.question;
        if (!history[qKey]) {
            history[qKey] = { count: 1, text: questionObj.question, ans: questionObj.options[questionObj.answer] };
        } else {
            history[qKey].count += 1;
        }
        localStorage.setItem('jlpt_wrong_history', JSON.stringify(history));
    }

    function finishQuiz() {
        isTesting = false;
        document.getElementById('quiz').classList.remove('active');
        document.getElementById('result').classList.add('active');
        document.getElementById('scoreDisplay').innerText = `${score} / 20`;
        const now = new Date();
        document.getElementById('resInfo').innerText = `å—é¨“è€…: ${document.getElementById('userName').value} | ${now.toLocaleString()}`;
        
        // ä»Šå›ã®æ­£èª¤è©³ç´°ã‚’ç”Ÿæˆ
        renderCurrentReview();
    }

    // ä»Šå›ã®20å•ã®æ­£èª¤ã‚’è¡¨ç¤º
    function renderCurrentReview() {
        const area = document.getElementById('currentReviewArea');
        area.innerHTML = '';
        currentQuestions.forEach((q, i) => {
            const isCorrect = userChoices[i] === q.answer;
            const div = document.createElement('div');
            div.className = `review-item ${isCorrect ? 'correct-bg' : 'wrong-bg'}`;
            div.innerHTML = `
                <div><span class="status-badge ${isCorrect ? 'bg-ok' : 'bg-ng'}">${isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£'}</span> <strong>å• ${i+1}:</strong> ${q.question}</div>
                <div style="margin-top:10px; font-size:14px;">
                    ã‚ãªãŸã®å›ç­”: <span style="color:${isCorrect ? 'green' : 'red'}">${q.options[userChoices[i]]}</span><br>
                    æ­£è§£: <strong>${q.options[q.answer]}</strong>
                </div>
            `;
            area.appendChild(div);
        });
    }

    // å±¥æ­´ãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    function showHistoryMode() {
        document.querySelectorAll('.info-section, .quiz-section, .result-section').forEach(s => s.classList.remove('active'));
        document.getElementById('history').classList.add('active');
        renderCumulativeList();
    }

    function renderCumulativeList() {
        const history = JSON.parse(localStorage.getItem('jlpt_wrong_history') || '{}');
        const lists = { 1: document.getElementById('list1'), 2: document.getElementById('list2'), 3: document.getElementById('list3') };
        Object.values(lists).forEach(l => l.innerHTML = '');
        let hasData = [false, false, false, false];

        for (const key in history) {
            const item = history[key];
            const div = document.createElement('div');
            div.className = 'wrong-item';
            div.innerHTML = `<strong>å•:</strong> ${item.text}<br><span style="color:blue"><strong>æ­£è§£:</strong> ${item.ans}</span> (ç´¯è¨ˆãƒŸã‚¹: ${item.count}å›)`;
            if (item.count === 1) { lists[1].appendChild(div); hasData[1] = true; }
            else if (item.count === 2) { lists[2].appendChild(div); hasData[2] = true; }
            else if (item.count >= 3) { lists[3].appendChild(div); hasData[3] = true; }
        }
        if(!hasData[1]) lists[1].innerText = 'ãªã—';
        if(!hasData[2]) lists[2].innerText = 'ãªã—';
        if(!hasData[3]) lists[3].innerText = 'ãªã—';
    }

    function clearHistory() {
        if(confirm("å…¨ã¦ã®ç´¯è¨ˆå­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('jlpt_wrong_history');
            renderCumulativeList();
        }
    }
</script>
</body>
</html>
