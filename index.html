<!DOCTYPE html>
<html lang="ja" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <title>JLPT N4 æ—¥æœ¬èªèƒ½åŠ›è©¦é¨“</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --accent: #4834d4;
            --success: #27ae60;
            --error: #eb4d4b;
            --text-main: #2d3436;
            --shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: var(--primary-bg);
            background-attachment: fixed;
            margin: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
            -webkit-user-select: none; user-select: none;
            overflow-x: hidden;
        }

        .container {
            width: 90%; max-width: 500px;
            background: var(--glass-bg);
            padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            text-align: center; position: relative;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .hidden { display: none !important; }

        h1, h2, h3 { color: var(--accent); margin-top: 0; }
        .input-group { text-align: left; margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #555; }
        
        input, select {
            width: 100%; padding: 12px; border: 2px solid #eee;
            border-radius: 10px; font-size: 16px; transition: 0.3s;
            -webkit-user-select: text; user-select: text;
        }
        input:focus { border-color: var(--accent); outline: none; }

        button {
            width: 100%; padding: 15px; background: var(--accent); color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: all 0.2s;
        }
        button:hover { transform: translateY(-2px); opacity: 0.9; box-shadow: 0 5px 15px rgba(72, 52, 212, 0.3); }

        .progress-container { width: 100%; height: 8px; background: #eee; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.4s ease; }
        .info-header { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: bold; }
        .question-text { font-size: 18px; font-weight: bold; margin: 25px 0; text-align: left; line-height: 1.6; }
        
        .option-btn {
            background: #fff; color: var(--text-main); border: 2px solid #eee;
            text-align: left; margin-bottom: 12px; font-weight: normal;
        }
        .option-btn:hover { border-color: var(--accent); background: #f8f9ff; }

        .score-big { font-size: 64px; font-weight: bold; color: var(--accent); margin: 10px 0; }
        .result-meta { font-size: 14px; color: #666; margin-bottom: 20px; }
        .analysis-scroll { max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; text-align: left; padding: 10px; }
        .analysis-card { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .tag-correct { background: #e3f9eb; color: var(--success); }
        .tag-wrong { background: #fee2e2; color: var(--error); }

        .tab-box { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 12px; background: #eee; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .history-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .history-item { padding: 12px; background: white; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid var(--accent); font-size: 14px; }

        #cheat-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.98); color: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px;
        }
        .cheat-title { font-size: 80px; color: var(--error); margin: 0; }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-wrap { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); z-index: 1000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="setup" class="container">
        <h1>N4 æ–‡æ³•ãƒ†ã‚¹ãƒˆ</h1>
        <div class="input-group">
            <label>æ°å (Full Name)</label>
            <input type="text" id="user-name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
        </div>
        <div class="input-group">
            <label>å­¦ç±ç•ªå· (Student ID)</label>
            <input type="text" id="user-id" placeholder="ä¾‹ï¼šS580">
        </div>
        <div class="input-group">
            <label>ã‚¯ãƒ©ã‚¹ (Class)</label>
            <select id="user-cls">
                <option value="SP12">SP12</option>
                <option value="SP13">SP13</option>
            </select>
        </div>
        <button onclick="initExam()">æµ‹è¯•å¼€å§‹</button>
        <button onclick="showHistory()" style="background:#555;">é”™é¢˜æŸ¥çœ‹</button>
        <button onclick="window.open('https://docs.google.com/spreadsheets/d/1h6CudBvYWLorOfHtO42nja--t2A1pWO1H8XnRts1PpA/edit?gid=0#gid=0')" style="background:#777; font-size:12px;">æ’è¡Œæ¦œ</button>
    </div>

    <div id="quiz" class="container hidden">
        <div class="info-header">
            <span id="quiz-user-info">ç­çº§ | å§“å</span>
            <span id="q-number">Q1 / 20</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
        <div class="question-text" id="q-text"></div>
        <div id="options-area"></div>
    </div>

    <div id="result" class="container hidden">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="result-meta" class="result-meta"></div>
        <div class="score-big" id="final-score">0 / 20</div>
        <div class="analysis-scroll" id="analysis-list"></div>
        <button onclick="location.reload()" style="margin-top:20px;">è¿”å›é¦–é¡µ</button>
    </div>

    <div id="history" class="container hidden">
        <h3>å¼±ç‚¹åˆ†æ</h3>
        <div class="tab-box">
            <div class="tab-btn active" id="tab-3" onclick="renderHistory(3)">ğŸ”¥ 3å›åŠä»¥ä¸Š</div>
            <div class="tab-btn" id="tab-2" onclick="renderHistory(2)">âš ï¸ 2å›</div>
            <div class="tab-btn" id="tab-1" onclick="renderHistory(1)">ğŸ“– 1å›</div>
        </div>
        <div id="history-content" class="history-list"></div>
        <button onclick="location.reload()" style="margin-top:15px; background:#555;">è¿”å›</button>
    </div>

    <div id="cheat-overlay" class="hidden">
        <h1 class="cheat-title">å¤±æ ¼</h1>
        <p style="font-size: 20px; text-align: center;">æ£€æµ‹åˆ°åˆ‡å±è¡Œä¸ºï¼Œæµ‹è¯•å·²ç»ˆæ­¢ã€‚</p>
        <button onclick="location.reload()" style="width: 200px; background: white; color: black;">è¿”å›</button>
    </div>

    <div id="loader" class="loader-wrap hidden">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:bold; color:var(--accent);">æ•°æ®ä¸Šä¼ ä¸­...</p>
    </div>

    <script src="questions_n4.js"></script>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwREfW1TphcbB9ZJLeEiM3SsS_GT5KrObR4dhcDRnfySmbxKGe23FWvBMTcX52HXJ_Czw/exec";
        const QUESTIONS_TO_DRAW = 20;

        let examPool = [];
        let currentIdx = 0;
        let score = 0;
        let quizActive = false;
        let examResults = [];
        let userInfo = {};

        function initExam() {
            // è¿™é‡Œçš„ allQuestions å¿…é¡»å­˜åœ¨äº questions_n4.js ä¸­
            if (typeof allQuestions === 'undefined') {
                alert("æœªå‘ç°é¢˜åº“æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ questions_n4.js å·²æ­£ç¡®ä¸Šä¼ è‡³ GitHub ä¸”ä¸ index.html åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹ã€‚");
                return;
            }

            userInfo.name = document.getElementById('user-name').value.trim();
            userInfo.id = document.getElementById('user-id').value.trim();
            userInfo.cls = document.getElementById('user-cls').value;

            if (!userInfo.name || !userInfo.id) return alert("è¯·è¾“å…¥å®Œæ•´çš„å§“åå’Œå­¦å·ã€‚");

            // å…¨å±€é¢˜åº“éšæœºæŠ½å–
            examPool = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, QUESTIONS_TO_DRAW);
            
            currentIdx = 0;
            score = 0;
            examResults = [];
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('quiz').classList.remove('hidden');
            document.getElementById('quiz-user-info').innerText = `${userInfo.cls} | ${userInfo.name}`;
            
            quizActive = true;
            showQuestion();
        }

        function showQuestion() {
            const q = examPool[currentIdx];
            document.getElementById('q-number').innerText = `Q${currentIdx + 1} / ${examPool.length}`;
            document.getElementById('p-bar').style.width = `${((currentIdx) / examPool.length) * 100}%`;
            document.getElementById('q-text').innerText = q.question;

            const area = document.getElementById('options-area');
            area.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                area.appendChild(btn);
            });
        }

        function selectOption(idx) {
            const q = examPool[currentIdx];
            const isCorrect = (idx === q.answer);
            if (isCorrect) score++;

            examResults.push({
                question: q.question,
                options: q.options,
                correctIdx: q.answer,
                userSelect: idx,
                isCorrect: isCorrect
            });

            if (!isCorrect) {
                let wrongList = JSON.parse(localStorage.getItem('N4_WRONG_LIST') || '{}');
                if (!wrongList[q.question]) {
                    wrongList[q.question] = { text: q.question, ans: q.options[q.answer], count: 1 };
                } else {
                    wrongList[q.question].count += 1;
                }
                localStorage.setItem('N4_WRONG_LIST', JSON.stringify(wrongList));
            }

            currentIdx++;
            if (currentIdx < examPool.length) {
                showQuestion();
            } else {
                finishExam();
            }
        }

        async function finishExam() {
            quizActive = false;
            document.getElementById('loader').classList.remove('hidden');

            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP');
            const timeStr = now.toLocaleTimeString('ja-JP');

            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            document.getElementById('result-meta').innerText = `${userInfo.cls} | ${userInfo.id} | ${userInfo.name}`;
            document.getElementById('final-score').innerText = `${score} / ${examPool.length}`;

            const list = document.getElementById('analysis-list');
            list.innerHTML = examResults.map((r, i) => `
                <div class="analysis-card">
                    <span class="tag ${r.isCorrect ? 'tag-correct' : 'tag-wrong'}">${r.isCorrect ? 'â—‹ æ­£è§£' : 'Ã— ä¸æ­£è§£'}</span><br>
                    <b>Q${i+1}. ${r.question}</b><br>
                    <small>ä½ çš„å›ç­”: ${r.options[r.userSelect]}</small><br>
                    <small style="color:var(--success)">æ­£ç¡®ç­”æ¡ˆ: ${r.options[r.correctIdx]}</small>
                </div>
            `).join('');

            const payload = {
                timestamp: now.toISOString(),
                name: userInfo.name,
                id: userInfo.id,
                cls: userInfo.cls,
                score: score,
                date: dateStr,
                time: timeStr
            };

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
            } catch (e) { console.error("Submit error:", e); }

            document.getElementById('loader').classList.add('hidden');
        }

        function showHistory() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('history').classList.remove('hidden');
            renderHistory(3);
        }

        function renderHistory(level) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${level}`).classList.add('active');

            const wrongData = JSON.parse(localStorage.getItem('N4_WRONG_LIST') || '{}');
            const list = document.getElementById('history-content');
            list.innerHTML = '';

            const filtered = Object.values(wrongData).filter(item => {
                if (level === 3) return item.count >= 3;
                if (level === 2) return item.count === 2;
                return item.count === 1;
            });

            if (filtered.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#999; padding-top:20px;'>æš‚æ— è®°å½•</p>";
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<b>${item.text}</b><br><small>æ­£ç¡®ç­”æ¡ˆ: ${item.ans}</small><br><small style="color:var(--error)">é”™è¯¯æ¬¡æ•°: ${item.count}æ¬¡</small>`;
                list.appendChild(div);
            });
        }

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden' && quizActive) {
                quizActive = false;
                document.getElementById('quiz').classList.add('hidden');
                document.getElementById('cheat-overlay').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
